services:
  app:
    build: .
    image: synesthetic-mcp
    container_name: synesthetic-mcp
    
    environment:
      - SYN_SCHEMAS_DIR
      - SYN_EXAMPLES_DIR
      - SYN_BACKEND_URL
    volumes:
      - .:/app
    command: pytest -q

  serve:
    build: .
    image: synesthetic-mcp
    environment:
      MCP_MODE: ${MCP_MODE:-tcp}
      MCP_ENDPOINT: ${MCP_ENDPOINT:-}
      MCP_HOST: ${MCP_HOST:-0.0.0.0}
      MCP_SOCKET_PATH: ${MCP_SOCKET_PATH:-/tmp/mcp.sock}
      MCP_SOCKET_MODE: ${MCP_SOCKET_MODE:-0600}
      MCP_PORT: ${MCP_PORT:-8765}
      MCP_READY_FILE: /tmp/mcp.ready
      SYN_SCHEMAS_DIR: ${SYN_SCHEMAS_DIR:-}
      SYN_EXAMPLES_DIR: ${SYN_EXAMPLES_DIR:-}
      SYN_BACKEND_URL: ${SYN_BACKEND_URL:-}
      LABS_SCHEMA_BASE: ${LABS_SCHEMA_BASE:-https://delk73.github.io/synesthetic-schemas/schema/}
      LABS_SCHEMA_VERSION: ${LABS_SCHEMA_VERSION:-0.7.3}
      LABS_SCHEMA_CACHE_DIR: ${LABS_SCHEMA_CACHE_DIR:-}

    volumes:
      - /tmp:/tmp
    command: ["python", "-m", "mcp"]
    ports:
      - "${MCP_PORT:-8765}:${MCP_PORT:-8765}"
    healthcheck:
      test: ["CMD-SHELL", "[ -f /tmp/mcp.ready ]"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 5s
