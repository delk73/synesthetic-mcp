{
  "task": "Audit synesthetic-mcp repo state (v0.2.8 features)",
  "objective": "Compare implementation, tests, and docs against docs/mcp_spec.md (v0.2.8). Report what is Present, Missing, or Divergent, and export an updated AGENTS.md snapshot for MCP.",
  "constraints": {
    "style": "deterministic, terse, Markdown headings with bullets/tables",
    "rules": [
      "Present = implementation matches spec and is covered by tests/docs",
      "Missing = spec requires feature but implementation does not provide it",
      "Divergent = implementation exists but differs in shape, naming, or behavior from spec",
      "Spec errors (validation_failed, not_found, etc.) must be inside JSON-RPC result; JSON-RPC error only for malformed frames",
      "Ground all findings in visible code/tests/docs; no speculation",
      "Recommendations must cite evidence (file path + line/section) and be actionable code/test/doc changes",
      "Always overwrite meta/output/mcp_state.md and AGENTS.md with non-empty content",

      "Transport compliance: STDIO MUST exist; Socket MUST support multi-client ordering; TCP MUST exist with 1 MiB guard per v0.2.8; HTTP/gRPC are roadmap-only (Divergent if present)",

      "Payload cap: 1 MiB guard enforced across all methods in STDIO, Socket, and TCP; explicit guard + failing test required",

      "Alias: method 'validate' MUST alias 'validate_asset'; log deprecation warning (until ≥ v0.3)",

      "Batching: validate_many MUST honor MCP_MAX_BATCH",

      "get_example: MUST return validation_failed when example invalid",

      "Schema resolution: MUST be local-only; path traversal rejected",

      "Determinism: sorting for listings, error ordering, diff ordering MUST be implemented + tested",

      "Security: Socket/TCP perms default to least-privilege; Container must run non-root",

      "Process model: STDIO exits when stdin closes; Socket/TCP log readiness + unlink/close on shutdown",

      "Logging: startup log includes mode, path/host:port, schemas_dir, examples_dir; stdout only JSON-RPC frames; stderr for logs; timestamps ISO-8601",

      "Signal handling: SIGINT/SIGTERM shutdowns return documented exit codes (-SIGINT, -SIGTERM)",

      "Shutdown logging: Shutdown logs MUST mirror ready logs (mode, address/path, schemas_dir, examples_dir, timestamp) and MUST be emitted before process exit; self-kill MUST NOT pre-empt log emission",

      "Ready file format MUST be '<pid> <ISO8601 timestamp>' exactly",

      "Schema validation contract (v0.2.8): Assets MUST include top-level \"$schema\" per JSON Schema Draft 2020-12; assets missing it MUST yield validation_failed with path=\"/$schema\"; use of legacy 'schema' or '$schemaRef' MUST be rejected; no function signatures or tests may take a 'schema' param",

      "Docs MUST include TCP client example using 'nc 127.0.0.1 8765'",

      "Audit incomplete unless both output files written non-empty"
    ],
    "sections": [
      "Summary of repo state",
      "Top gaps & fixes (3-5 bullets)",
      "Alignment with mcp_spec.md (table: Spec item → Status → Evidence)",
      "Transports",
      "STDIO entrypoint & process model",
      "Socket server (multi-client handling, perms, unlink, logs)",
      "TCP server (binding, perms, multi-client, shutdown logs)",
      "Lifecycle signals",
      "Shutdown logging invariant",
      "Ready file format",
      "Golden request/response examples",
      "Payload size guard",
      "Schema validation contract",
      "Batching",
      "Logging hygiene",
      "Container & health",
      "Schema discovery & validation",
      "Test coverage",
      "Dependencies & runtime",
      "Environment variables",
      "Documentation accuracy",
      "Detected divergences",
      "Recommendations"
    ]
  },
  "scope": {
    "files": [
      "README.md",
      "docs/mcp_spec.md",
      "requirements.txt",
      "docker-compose.yml",
      "Dockerfile",
      "serve.sh",
      "up.sh",
      "down.sh",
      "mcp/*.py",
      "tests/*.py",
      "libs/synesthetic-schemas",
      "meta/",
      "AGENTS.md",
      ".github/workflows/",
      ".env.example"
    ]
  },
  "output": {
    "paths": [
      "meta/output/mcp_state.md",
      "AGENTS.md"
    ],
    "format": "Markdown",
    "must_write": true,
    "stdout_optional": true
  },
  "exit_criteria": [
    "meta/output/mcp_state.md written and non-empty",
    "AGENTS.md snapshot updated",
    "Spec v0.2.8 features mapped to Present/Missing/Divergent with evidence",
    "STDIO, Socket, and TCP behavior explicitly verified (multi-client ordering, logs, shutdown, lifecycle signals)",
    "Golden examples cover list_schemas, get_schema, validate_asset+alias, get_example success+validation_failed, diff_assets, malformed JSON-RPC",
    "Payload guard verified across all transports and methods",
    "Batching (validate_many) verified or marked",
    "Determinism + schema safety verified",
    "Logging verified (mode, path/host:port, schemas_dir, examples_dir, ISO timestamps)",
    "Shutdown logging invariant verified (shutdown log emitted before exit, mirrors ready log, no pre-emptive self-kill)",
    "Ready file format '<pid> <ISO8601 timestamp>' verified",
    "Signal exit codes verified (-SIGINT, -SIGTERM)",
    "Container non-root verified",
    "README cross-checked with docs/mcp_spec.md, including TCP nc example",
    "Assets with \"$schema\" pass strict validation; assets using 'schema' or '$schemaRef' are rejected with validation_failed"
  ]
}
