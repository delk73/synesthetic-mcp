# MCP Spec (Python v1)

## Purpose
Expose Synesthetic schemas, examples, and validation as **MCP resources and tools**.  
Keep the server lightweight, stateless, and strictly an adapter:

- **Resources**: serve schemas and examples, unmodified, from the SSOT repo.  
- **Tools**: wrap validation, diff, and backend population behind deterministic IO contracts.  
- **Guards**: enforce SSOT compliance before persistence; never mutate schemas.

## Boundaries
- **Stateless**: no durable storage; only transient, in-memory schema cache.  
- **Schema source**: authoritative schemas live in [`synesthetic-schemas`](https://github.com/delk73/synesthetic-schemas).  
  - MCP must not patch, override, or invent schema behavior.  
  - Schema loading: cache populated on startup by reading from the SSOT directory/package.  
  - Refresh: MCP v1 requires restart to pick up schema updates (no polling or push).  
- **Backend**: remains CRUD/persistence only; MCP is just a proxy.  
- **Lab**: exploratory or generative logic lives in its own repo later.  
- **Auth/Rate limiting**: explicitly out of scope for v1; assumed handled by upstream API gateway.  

---

## Resources

- **`schemas/`**  
  - List available schemas (names, versions, paths).  
  - Fetch full JSON Schema (exact copy from SSOT).  

- **`examples/`**  
  - List examples by component.  
  - Fetch example JSON and validate inline against SSOT schemas.  

- **`assets/` (proxy)**  
  - *Optional in v1.* If enabled, MCP forwards list/fetch calls to the backend API.  
  - No mutation tools are exposed in v1.  

---

## Tools

- **`list_schemas()`**  
  → `[{"name":"NestedSynestheticAsset","version":"0.7.0","path":"..."}]`

- **`get_schema(name:str)`**  
  → `{ "schema": {...}, "version":"0.7.0" }`

- **`list_examples(component:str)`**  
  → `[{"path":"examples/shader/foo.json"}, …]`

- **`get_example(path:str)`**  
  → `{ "example": {...}, "schema":"Shader", "validated":true }`

- **`validate_asset(asset:dict, schema:str)`**  
  → `{ "ok": true, "errors": [] }`  
  or  
  → `{ "ok": false, "errors":[{"path":"/shader/uniforms/0","msg":"expected number"}] }`

- **`diff_assets(base:dict, new:dict)`**  
  → `{ "ok": true, "patch":[{ "op":"replace","path":"/shader/uniforms/0","value":1.5 }] }`  
  *Scope*: v1 supports `add`, `remove`, and `replace` only (no move/copy/test).  

- **`populate_backend(asset:dict, validate_first:bool=true)`**  
  → `{ "ok": true, "asset_id":"uuid", "backend_url":"http://.../synesthetic-assets/nested/uuid" }`  
  or  
  → `{ "ok": false, "reason":"validation_failed", "errors":[...] }`  
  *Notes*:  
  - `asset_id` is always generated by the backend (UUID v4).  
  - v1 always creates new assets; updates are out of scope.  

---

## Error Model

- **Validation errors**:  
  ```json
  { "ok": false, "reason": "validation_failed",
    "errors": [{ "path":"/shader/uniforms/0", "msg":"expected number" }] }
````

* **Backend errors**:

  ```json
  { "ok": false, "reason":"backend_error", "status":500, "detail":"…" }
  ```

* **Unsupported tool/resource**:

  ```json
  { "ok": false, "reason":"unsupported", "msg":"tool not implemented" }
  ```

* **Network errors** (timeouts, refused connections):

  ```json
  { "ok": false, "reason":"backend_error", "status":503, "detail":"network_unreachable" }
  ```

---

## Implementation (Python)

* **Framework**: FastAPI (HTTP) + stdio adapter.
* **Validation**: reuse SSOT Pydantic bindings + `jsonschema`.
* **HTTP client**: `httpx` with 5s timeout, no retries.
* **Testing**: pytest, golden fixtures for each tool.
* **Packaging**: pip-installable; depends on `synesthetic-schemas` (preferred: submodule for lockstep versioning).
* **API versioning**: v1 is implicit in deployment. Formal `/v1/` URL prefix may be added later.
* **Determinism**: MCP may sort outputs or error paths, but must not alter schema semantics.

---

## Repo Layout

```
synesthetic-mcp/
  README.md
  docs/
    mcp_spec.md
  mcp/
    __init__.py
    core.py          # schema/example discovery
    validate.py      # validation helpers
    diff.py          # JSON Patch generation
    backend.py       # proxy client
    stdio_main.py    # MCP stdio adapter
    http_main.py     # optional FastAPI adapter
  tests/
    test_validate.py
    test_diff.py
    test_tools.py
    fixtures/
      valid_asset.json
      invalid_asset.json
```

---

## Exit Criteria

* All resources/tools return deterministic JSON.
* CI runs pytest, pre-commit, and validates golden fixtures.
* Backend population tested against a mock backend (no DB dependency).
* No schema opinions live here; SSOT is authoritative.
* Schema cache refresh requires restart in v1 (explicit design choice).
